<h1 id="bootloaders">Bootloaders</h1>
<ul>
<li><a href="#grub-1">GRUB 1</a>
<ul>
<li><a href="#grub-1---installation">Installation</a></li>
<li><a href="#grub-1---recovery">Recovery</a></li>
</ul></li>
<li><a href="#grub-2">GRUB 2</a>
<ul>
<li><a href="#grub-2---installation">Installation</a></li>
<li><a href="#grub-2---configuration">Configuration</a></li>
<li><a href="#grub-2---recovery">Recovery</a></li>
</ul></li>
</ul>
<h2 id="grub-1">GRUB 1</h2>
<p>GRUB 1 is a legacy version of GRUB that is no longer supported. The last version made available was 0.97 in 2008. GRUB 2 should be used for newer Linux distributions.</p>
<h3 id="grub-1---installation">GRUB 1 - Installation</h3>
<p>Install GRUB to the primary drive. This will use the MSDOS partition scheme on the first 512 bytes as GPT was not supported until GRUB 2.</p>
<pre><code># grub-install --root-directory=/ /dev/&lt;DEVICE&gt;</code></pre>
<p>A basic boot menu must be configured to specify the boot partition, the kernel to use, the root partition to mount, and the initrd/initramfs to load.</p>
<pre><code># vim /boot/grub/menu.lst
root   (hd0,0)
kernel /vmlinuz-linux root=/dev/sda2 ro
initrd /initramfs-linux.img</code></pre>
<p>[1]</p>
<p>Source:</p>
<ol style="list-style-type: decimal">
<li>&quot;GRUB Legacy.&quot; Arch Linux Wiki. January 11, 2017. Accessed February 8, 2017. https://wiki.archlinux.org/index.php/GRUB_Legacy</li>
</ol>
<h3 id="grub-1---recovery">GRUB 1 - Recovery</h3>
<p>When GRUB fails to boot, or if the boot settings need to be modified, the GRUB recovery shell can be used.</p>
<p>Common options:</p>
<ul>
<li>help = Show help messages.</li>
<li>cat = View the contents of a file.</li>
<li>find = View the contents of a file or locate a specific file.</li>
<li>dhcp = Obtain an IP address from DHCP.</li>
<li>ifconfig = Manually configure IP addressing.</li>
<li>tftpserver = Specify a TFTP server to PXE boot from.</li>
<li>module = Load a GRUB module.</li>
<li>root hd(<code>X</code>,<code>Y</code>) = Specify the root drive <code>X</code> and partition <code>Y</code> (the partition starts at &quot;0&quot; in GRUB 1 and &quot;1&quot; in GRUB 2). Use the &quot;Tab&quot; key on the keyboard to auto-complete if the partitions are unknown.</li>
<li>boot = Boot the operating system.</li>
<li>halt = Turn the computer off.</li>
<li>reboot = Reboot the computer</li>
</ul>
<p>Example of manually booting a server:</p>
<pre><code>grub&gt; root hd(0,0)
grub&gt; kernel /vmzlinuz-4.0.img root=/dev/sda2 ro
grub&gt; initrd /initramfs-4.0.img
grub&gt; boot</code></pre>
<p>[1]</p>
<p>Source:</p>
<ol style="list-style-type: decimal">
<li>&quot;GNU GRUB Manual 0.97.&quot; GNU. Accessed February 8, 2017. https://www.gnu.org/software/grub/manual/legacy/grub.html</li>
</ol>
<h2 id="grub-2">GRUB 2</h2>
<p>GRUB stands for the GRand Unified Bootloader. It was designed to be cross platform compatible with most operating systems including BSD, Linux, and Windows variants.</p>
<h3 id="grub-2---installation">GRUB 2 - Installation</h3>
<p>GRUB must be installed onto the start of the entire drive, not a partition, to avoid issues in the case of partitions needing to be modified. The first 512 bytes of a drive are used for the Master Boot Record (MBR). If you are using a GPT partition then it uses the first 2048 bytes. GRUB will add it's own data right after that. It is usually a safe and recommended option to create your first partition 1MB after the start of the drive, especially if GPT is in use.</p>
<p>Install GRUB to a drive (replace &quot;X&quot;) and then generate a boot menu configuration file. This will create the menu file that loads up to the end-user upon boot.</p>
<pre><code># grub-install /dev/sdX
# grub-mkconfig -o /boot/grub/grub.cfg</code></pre>
<p>If any changes are made to GRUB's settings and/or it's various scripts, run this command to update the changes. [1]</p>
<pre><code># update-grub</code></pre>
<p>Common &quot;grub-install&quot; options: * compress = Compress GRUB-related files. Valid options are: * no (default), xz, gz, lzo * --modules = List kernel modules that are required for boot. Depending on the end-user's setup, &quot;lvm&quot;, &quot;raid&quot; (for mdadm), and/or &quot;encrypt&quot; (for LUKS) may be required. * --force = Install despite any warnings. * --recheck = Remove the original /boot/grub/device.map file (if it exists) and then review the current mapping of partitions. * --boot-directory = The directory that the &quot;grub/&quot; folder should exist in. This is typically &quot;/boot&quot;. [2]</p>
<p>Sources:</p>
<ol style="list-style-type: decimal">
<li>&quot;GRUB.&quot; Arch Linux Wiki. May 27, 2016. https://wiki.archlinux.org/index.php/GRUB</li>
<li>&quot;GRUB2-INSTALL MAN PAGE.&quot; Mankier. Feburary 26, 2014. https://www.mankier.com/8/grub2-install</li>
</ol>
<h3 id="grub-2---configuration">GRUB 2 - Configuration</h3>
<p>Important files:</p>
<table style="width:24%;">
<colgroup>
<col width="6%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th>FILE</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>/etc/default/grub</td>
<td>GRUB settings.</td>
</tr>
<tr class="even">
<td>/etc/grub.d/</td>
<td>A folder with various scripts that make up the grub.cfg. Scripts prefixed with lower numbers are executed first.</td>
</tr>
<tr class="odd">
<td>/boot/grub/grub.cfg</td>
<td>This is automatically generated using the settings from /etc/default/grub and the scripts in /etc/grub.d/. Manual changes may get overwritten.</td>
</tr>
</tbody>
</table>
<p>Common Options: * /etc/default/grub * GRUB_DEFAULT = The default menu entry to autoboot into. * saved = Boot from the last option selected. This is cached in the /boot/grub/grubenv file. * Alternatively, this can either be the number of the &quot;menuentry&quot; section, in order from top to bottom, starting at 0. * Or the menu entry title can be explicitly specified. For example, &quot;CentOS Linux (3.10.0-327.13.1.el7.x86_64) 7 (Core).&quot;</p>
<pre><code># grep ^menuentry /boot/grub2/grub.cfg</code></pre>
<pre><code>menuentry &#39;CentOS Linux (3.10.0-327.18.2.el7.x86_64) 7 (Core)&#39; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &#39;gnulinux-3.10.0-327.18.2.el7.x86_64-advanced-d2e5b723-0055-4157-9197-e7d715937e8b&#39; {</code></pre>
<pre><code>menuentry &#39;CentOS Linux (3.10.0-327.13.1.el7.x86_64) 7 (Core)&#39; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &#39;gnulinux-3.10.0-327.13.1.el7.x86_64-advanced-d2e5b723-0055-4157-9197-e7d715937e8b&#39; {</code></pre>
<ul>
<li>GRUB_TIMEOUT = Set the timeout (in seconds) before booting into the default menu entry.</li>
<li>GRUB_CMDLINE_LINUX = Append kernel options to the end of the &quot;linux&quot; line. These can later be seen in the operating system in /proc/cmdline. This applies to both the normal and recovery mode options.</li>
<li>GRUB_CMDLINE_LINUX_DEFAULT = The same as the above setting except this option does not affect the recovery kernel options.</li>
<li>GRUB_DISABLE_LINUX_UUID = If set to &quot;true&quot;, devices from /dev/ will be used for specifying the root instead of the UUID. The default is &quot;false&quot; which will use UUIDs.</li>
<li>GRUB_BACKGROUND = Specify the full path to a custom image for GRUB's menu background.</li>
</ul>
<p>[1]</p>
<p>Source:</p>
<ol style="list-style-type: decimal">
<li>&quot;GRUB2/Setup.&quot; Ubuntu Documentation. November 29, 2015. https://help.ubuntu.com/community/Grub2/Setup</li>
</ol>
<h3 id="grub-2---recovery">GRUB 2 - Recovery</h3>
<p>In cases where GRUB fails (because it was installed incorrectly), the end-user is automatically switched into GRUB's rescue shell.</p>
<p>Common options:</p>
<ul>
<li>insmod = Load kernel modules.</li>
<li>ls = List partitions and file systems within them.</li>
<li>cat = View file contents.</li>
<li>set = Set a boot option.</li>
<li>unset = Remove a boot option.</li>
<li>boot = Attempt to boot again.</li>
<li>halt = Shutdown the computer.</li>
<li>reboot = Restart the computer.</li>
</ul>
<p>The rescue prompt will look similar to this.</p>
<pre><code>grub rescue&gt;</code></pre>
<p>Example of using these commands to do a custom rescue boot.</p>
<pre><code>grub rescue&gt; ls
(hd0) (hd0,msdos1)
grub rescue&gt; ls (hd0,1)/boot/
grub/
vmlinuz
initramfs-linux.img
grub rescue&gt; set root=(hd0,1)
grub rescue&gt; linux /boot/vmlinuz root=/dev/sda1
grub rescue&gt; initrd /boot/initramfs-linux.img
grub rescue&gt; boot</code></pre>
<p>Alternatively, you can switch back to the graphical GRUB menu and make changes there.</p>
<pre><code>grub rescue&gt; insmod normal
grub rescue&gt; normal</code></pre>
<p>For recovering from a corrupt GRUB installation, fully change root into the environment from a live CD, USB, or PXE network boot. Then you can modify configuration files and re-install GRUB using the same commands used during the installation.</p>
<p>In this example, /dev/sda2 is the root partition and /dev/sda1 is the boot partition. [1]</p>
<pre><code># mount /dev/sda2 /mnt
# mount /dev/sda1 /mnt/boot
# mount --bind /dev /mnt/dev
# mount --bind /run /mnt/run
# mount --bind /sys /mnt/sys
# chroot /mnt
# /bin/bash
# export PATH=&quot;$PATH:/sbin:/bin&quot;</code></pre>
<p>If you need to recover GRUB from a chroot that is based on a LVM on the host node, make sure that LVM tools are installed on the guest. This way it can properly see the logical volume as a block device.</p>
<pre><code>Debian/Ubuntu
# apt-get install lvm2</code></pre>
<pre><code>RHEL/Fedora
# yum install lvm2</code></pre>
<p>Sources:</p>
<ol style="list-style-type: decimal">
<li>&quot;Grub2/Installing.&quot; Ubuntu Documentation. March 6, 2015. https://help.ubuntu.com/community/Grub2/Installing</li>
<li>&quot;GNU GRUB Manual 2.00.&quot; GNU. Accessed June 27, 2016. https://www.gnu.org/software/grub/manual/grub.html</li>
</ol>
